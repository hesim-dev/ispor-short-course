<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Individual Patient Simulation • learnCEA</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Individual Patient Simulation">
<meta property="og:description" content="learnCEA">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">learnCEA</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/simple-markov-cohort-model.html">Simple Markov Cohort Model</a>
    </li>
    <li>
      <a href="../articles/probabilistic-sensitivity-analysis.html">Incorporating Probabilistic Sensitivity Analysis</a>
    </li>
    <li>
      <a href="../articles/simple-markov-cohort-model-hesim.html">Simple Markov Cohort Model (hesim)</a>
    </li>
    <li>
      <a href="../articles/partitioned-survival-model.html">Partitioned Survival Model</a>
    </li>
    <li>
      <a href="../articles/individual-patient-simulation.html">Individual Patient Simulation</a>
    </li>
    <li>
      <a href="../articles/decision-analysis.html">Decision Analysis</a>
    </li>
    <li class="divider">
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/hesim-dev/ispor-short-course/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Individual Patient Simulation</h1>
            
            <h4 class="date">2020-07-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/hesim-dev/ispor-short-course/blob/master/vignettes/individual-patient-simulation.Rmd"><code>vignettes/individual-patient-simulation.Rmd</code></a></small>
      <div class="hidden name"><code>individual-patient-simulation.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a><span class="header-section-number">1</span> Overview</h1>
<p>Continuous time state transition models (CTSTMs) simulate trajectories for patients between mutually exclusive health states. These models can be parameterized using multi-state models, which are generalizations of survival models with more than two states. Transitions between health states <span class="math inline">\(r\)</span> and <span class="math inline">\(s\)</span> for patient <span class="math inline">\(i\)</span> with treatment <span class="math inline">\(k\)</span> at time <span class="math inline">\(t\)</span> are governed by hazard functions, <span class="math inline">\(\lambda_{rs}(t|x_{ik})\)</span>, that can depend on covariates <span class="math inline">\(x_{ik}\)</span>.</p>
<p>Different assumptions can be made about the time scales used to determine the hazards. In a “clock forward” (i.e., Markov) model, time <span class="math inline">\(t\)</span> refers to time since entering the initial health state. Conversely, in a “clock reset” (i.e., semi-Markov) model, time <span class="math inline">\(t\)</span> refers to time since entering the current state <span class="math inline">\(r\)</span>, meaning that time resets to 0 each time a patient enters a new state.</p>
<p>While state occupancy probabilities in “clock forward” models can be estimated analytically using the <a href="https://www.jstor.org/stable/pdf/4615704.pdf">Aalen-Johansen</a> estimator, state occupancy probabilities in “clock reset” models can only be computed in a general fashion using individual patient simulation. <code>hesim</code> provides support for individual-level CTSTMs (iCTSTMs) which can simulate either “clock forward” or “clock reset” models.</p>
<p>Discounted costs and quality-adjusted life-years (QALYs) are computed using the continuous time present value of a flow of state values—<span class="math inline">\(q_{hik}(t)\)</span> for utility and <span class="math inline">\(c_{m, hik}(t)\)</span> for the <span class="math inline">\(m\)</span>th cost category—that depend on the health state of a patient on a given treatment strategy at a particular point in time. Discounted QALYs and costs given a model starting at time <span class="math inline">\(0\)</span> with a time horizon of <span class="math inline">\(T\)</span> are then given by,</p>
<p><span class="math display">\[
\begin{aligned}
QALYs_{hik} &amp;= \int_{0}^{T} q_{hik}(t)e^{-rt}dt, \\ 
Costs_{m, hik} &amp;= \int_{0}^{T} c_{m, hik}(t)e^{-rt}dt,
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(r\)</span> is the discount rate.</p>
</div>
<div id="an-example-3-state-model" class="section level1">
<h1 class="hasAnchor">
<a href="#an-example-3-state-model" class="anchor"></a><span class="header-section-number">2</span> An example 3-state model</h1>
<p>The reversible illness-death model is a commonly used state transition model (see figure below) with 3 health states and 4 transitions. In this example, we will use 3 generic health states: (1) Healthy, (2) Sick, and (3) Dead. The following 4 transitions are possible.</p>
<ol style="list-style-type: decimal">
<li>Healthy to Sick</li>
<li>Sick to Healthy</li>
<li>Healthy to Dead</li>
<li>Sick to Dead</li>
</ol>
<p><br><img src="reversible-illness-death.png" width="500px"><br><br></p>
<p>In general, the transitions of a multi-state model can be characterized with an H x H transition matrix where <span class="math inline">\(H\)</span> is the number of health states, which is a square-matrix where the (r,s) element is a positive integer if a transition from r to s is possible and NA otherwise. A 4 x 4 transition matrix is appropriate for the reversible illness death model.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="no">tmat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">NA</span>, <span class="fl">1</span>, <span class="fl">2</span>),
              <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>, <span class="fl">NA</span>, <span class="fl">4</span>),
              <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">NA</span>, <span class="fl">NA</span>, <span class="fl">NA</span>))
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">tmat</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">tmat</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Healthy"</span>, <span class="st">"Sick"</span>, <span class="st">"Dead"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">tmat</span>)</pre></body></html></div>
<pre><code>##         Healthy Sick Dead
## Healthy      NA    1    2
## Sick          3   NA    4
## Dead         NA   NA   NA</code></pre>
<p>In a cost-effectiveness analysis, the treatments strategies of interest and characteristics of the target population must be specified in addition to the selected model structure. We will consider a simple case with two treatment strategies and a heterogeneous population of 1000 patients who differ by age and gender. The model contains 3 health states (2 of which are non-death states).</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"hesim"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"data.table"</span>)
<span class="no">strategies</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(<span class="kw">strategy_id</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>))
<span class="no">n_patients</span> <span class="kw">&lt;-</span> <span class="fl">1000</span>
<span class="no">patients</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(<span class="kw">patient_id</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="no">n_patients</span>,
                       <span class="kw">age</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n_patients</span>, <span class="kw">mean</span> <span class="kw">=</span> <span class="fl">45</span>, <span class="kw">sd</span> <span class="kw">=</span> <span class="fl">7</span>),
                       <span class="kw">female</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="no">n_patients</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="fl">.51</span>))
<span class="no">states</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(<span class="kw">state_id</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>),
                     <span class="kw">state_name</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Healthy"</span>, <span class="st">"Sick"</span>)) <span class="co"># Non-death health states</span>
<span class="no">hesim_dat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hesim/man/hesim_data.html">hesim_data</a></span>(<span class="kw">strategies</span> <span class="kw">=</span> <span class="no">strategies</span>,
                        <span class="kw">patients</span> <span class="kw">=</span> <span class="no">patients</span>,
                        <span class="kw">states</span> <span class="kw">=</span> <span class="no">states</span>)</pre></body></html></div>
</div>
<div id="parameter-estimation" class="section level1">
<h1 class="hasAnchor">
<a href="#parameter-estimation" class="anchor"></a><span class="header-section-number">3</span> Parameter estimation</h1>
<div id="multi-state-model" class="section level2">
<h2 class="hasAnchor">
<a href="#multi-state-model" class="anchor"></a><span class="header-section-number">3.1</span> Multi-state model</h2>
<p>CTSTMs can be parameterized by fitting statistical models in <code>R</code> or by storing the parameters from a model fit outside <code>R</code> as described in the <a href="intro.html#disease-progression">introduction</a> to <code>hesim</code>. Either a single joint model can be estimated encompassing all transitions or separate models can be estimated for each possible transition. In the <a href="intro.html#disease-progression">introduction</a> we considered a joint model; here, we will fit separate models. A number of parametric and flexibly parametric approaches are available (as described more detail in the <code><a href="https://rdrr.io/pkg/hesim/man/params_surv.html">params_surv()</a></code> documentation), but we will illustrate with a generalized gamma model.</p>
<p>We will begin by fitting a “clock reset” model using <code><a href="https://rdrr.io/pkg/flexsurv/man/flexsurvreg.html">flexsurvreg()</a></code>.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"flexsurv"</span>)
<span class="no">n_trans</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">tmat</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>) <span class="co"># Number of transitions</span>
<span class="no">wei_fits_cr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="kw">length</span> <span class="kw">=</span> <span class="no">n_trans</span>, <span class="kw">mode</span> <span class="kw">=</span> <span class="st">"list"</span>)
<span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">wei_fits_cr</span>)){
  <span class="no">wei_fits_cr</span><span class="kw">[[</span><span class="no">i</span>]] <span class="kw">&lt;-</span> <span class="kw pkg">flexsurv</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/flexsurv/man/flexsurvreg.html">flexsurvreg</a></span>(<span class="fu">Surv</span>(<span class="no">years</span>, <span class="no">status</span>) ~ <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">strategy_id</span>),
                                            <span class="kw">data</span> <span class="kw">=</span> <span class="no">mstate3_exdata</span>$<span class="no">transitions</span>,
                                            <span class="kw">subset</span> <span class="kw">=</span> (<span class="no">trans</span> <span class="kw">==</span> <span class="no">i</span>) ,
                                            <span class="kw">dist</span> <span class="kw">=</span> <span class="st">"weibull"</span>)
}
<span class="no">wei_fits_cr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hesim/man/flexsurvreg_list.html">flexsurvreg_list</a></span>(<span class="no">wei_fits_cr</span>)</pre></body></html></div>
<p>“Clock forward” models are fit in a similar fashion by specifying both the starting (<code>Tstop</code>) and stopping (<code>Tstop</code>) times associated with each transition.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">wei_fits_cf</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="kw">length</span> <span class="kw">=</span> <span class="no">n_trans</span>, <span class="kw">mode</span> <span class="kw">=</span> <span class="st">"list"</span>)
<span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">wei_fits_cf</span>)){
  <span class="no">wei_fits_cf</span><span class="kw">[[</span><span class="no">i</span>]] <span class="kw">&lt;-</span> <span class="kw pkg">flexsurv</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/flexsurv/man/flexsurvreg.html">flexsurvreg</a></span>(<span class="fu">Surv</span>(<span class="no">Tstart</span>, <span class="no">Tstop</span>, <span class="no">status</span>) ~ <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">strategy_id</span>),
                                            <span class="kw">data</span> <span class="kw">=</span> <span class="no">mstate3_exdata</span>$<span class="no">transitions</span>,
                                            <span class="kw">subset</span> <span class="kw">=</span> (<span class="no">trans</span> <span class="kw">==</span> <span class="no">i</span>) ,
                                            <span class="kw">dist</span> <span class="kw">=</span> <span class="st">"weibull"</span>)
}
<span class="no">wei_fits_cf</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hesim/man/flexsurvreg_list.html">flexsurvreg_list</a></span>(<span class="no">wei_fits_cf</span>)</pre></body></html></div>
</div>
<div id="utility-and-costs" class="section level2">
<h2 class="hasAnchor">
<a href="#utility-and-costs" class="anchor"></a><span class="header-section-number">3.2</span> Utility and costs</h2>
<p>The most straightforward way to assign utility and cost values to health states is with a <code><a href="https://rdrr.io/pkg/hesim/man/stateval_tbl.html">stateval_tbl()</a></code>. For example, we can specify the mean and standard error of utilities by health state (implying that utility values do not vary by treatment strategy or patient) and that we will use a beta distribution to randomly sample utility values for the probabilistic sensitivity analysis (PSA).</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">utility_tbl</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hesim/man/stateval_tbl.html">stateval_tbl</a></span>(<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(<span class="kw">state_id</span> <span class="kw">=</span> <span class="no">states</span>$<span class="no">state_id</span>,
                                       <span class="kw">mean</span> <span class="kw">=</span> <span class="no">mstate3_exdata</span>$<span class="no">utility</span>$<span class="no">mean</span>,
                                       <span class="kw">se</span> <span class="kw">=</span> <span class="no">mstate3_exdata</span>$<span class="no">utility</span>$<span class="no">se</span>),
                            <span class="kw">dist</span> <span class="kw">=</span> <span class="st">"beta"</span>,
                            <span class="kw">hesim_data</span> <span class="kw">=</span> <span class="no">hesim_dat</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">utility_tbl</span>)</pre></body></html></div>
<pre><code>##    state_id mean        se
## 1:        1 0.65 0.1732051
## 2:        2 0.85 0.2000000</code></pre>
<p>Drug and medical costs can be specified in a similar fashion. Drug costs are assumed to known with certainty and vary by treatment strategy whereas medical costs are assumed to vary by health state and to follow a gamma distribution.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">drugcost_tbl</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hesim/man/stateval_tbl.html">stateval_tbl</a></span>(<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(<span class="kw">strategy_id</span> <span class="kw">=</span> <span class="no">strategies</span>$<span class="no">strategy_id</span>,
                                       <span class="kw">est</span> <span class="kw">=</span> <span class="no">mstate3_exdata</span>$<span class="no">costs</span>$<span class="no">drugs</span>$<span class="no">costs</span>),
                            <span class="kw">dist</span> <span class="kw">=</span> <span class="st">"fixed"</span>,
                            <span class="kw">hesim_data</span> <span class="kw">=</span> <span class="no">hesim_dat</span>)
<span class="no">medcost_tbl</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hesim/man/stateval_tbl.html">stateval_tbl</a></span>(<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(<span class="kw">state_id</span> <span class="kw">=</span> <span class="no">states</span>$<span class="no">state_id</span>,
                                       <span class="kw">mean</span> <span class="kw">=</span> <span class="no">mstate3_exdata</span>$<span class="no">costs</span>$<span class="no">medical</span>$<span class="no">mean</span>,
                                       <span class="kw">se</span> <span class="kw">=</span> <span class="no">mstate3_exdata</span>$<span class="no">costs</span>$<span class="no">medical</span>$<span class="no">se</span>),
                            <span class="kw">dist</span> <span class="kw">=</span> <span class="st">"gamma"</span>,
                            <span class="kw">hesim_data</span> <span class="kw">=</span> <span class="no">hesim_dat</span>)</pre></body></html></div>
</div>
</div>
<div id="simulation" class="section level1">
<h1 class="hasAnchor">
<a href="#simulation" class="anchor"></a><span class="header-section-number">4</span> Simulation</h1>
<div id="constructing-the-economic-model" class="section level2">
<h2 class="hasAnchor">
<a href="#constructing-the-economic-model" class="anchor"></a><span class="header-section-number">4.1</span> Constructing the economic model</h2>
<p>As in any <code>hesim</code> model, the economic model consists of a model for disease progression and models for assigning utility and cost values to health states. In this example, we will use 1000 samples of the parameters for the probabilistic sensitivity analysis (PSA).</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">n_samples</span> <span class="kw">&lt;-</span> <span class="fl">1000</span></pre></body></html></div>
<div id="disease-model" class="section level3">
<h3 class="hasAnchor">
<a href="#disease-model" class="anchor"></a><span class="header-section-number">4.1.1</span> Disease model</h3>
<p>We begin by constructing the model for health state transitions, which is a function of input data (i.e., covariates) and a fitted multi-state model (or a parameter object). When separate multi-state models are fit by transition, the input data consists of one observation for each treatment strategy and patient combination (joint models consist of one observation for each treatment strategy, patient, and transition combination). It can be created easily by using the <code><a href="https://rdrr.io/pkg/hesim/man/expand.html">expand()</a></code> function to expand the <code><a href="https://rdrr.io/pkg/hesim/man/hesim_data.html">hesim_data()</a></code> object created above.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">transmod_data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hesim/man/expand.html">expand</a></span>(<span class="no">hesim_dat</span>,
                        <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"strategies"</span>, <span class="st">"patients"</span>))
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">transmod_data</span>)</pre></body></html></div>
<pre><code>##    strategy_id patient_id      age female
## 1:           1          1 56.59987      0
## 2:           1          2 47.12960      1
## 3:           1          3 43.77844      1
## 4:           1          4 34.36039      1
## 5:           1          5 35.19581      0
## 6:           1          6 45.22006      1</code></pre>
<p>“Clock reset” and “clock forward” transition models are created by combining the fitted models and input data with the transition matrix, desired number of PSA samples, the timescale of the model, and the starting age of each patient in the simulation (by default, patients are assumed to live no longer than age 100 in the individual-level simulation).</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">transmod_cr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hesim/man/create_IndivCtstmTrans.html">create_IndivCtstmTrans</a></span>(<span class="no">wei_fits_cr</span>, <span class="no">transmod_data</span>,
                                      <span class="kw">trans_mat</span> <span class="kw">=</span> <span class="no">tmat</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="no">n_samples</span>,
                                      <span class="kw">clock</span> <span class="kw">=</span> <span class="st">"reset"</span>,
                                      <span class="kw">start_age</span> <span class="kw">=</span> <span class="no">patients</span>$<span class="no">age</span>)
<span class="no">transmod_cf</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hesim/man/create_IndivCtstmTrans.html">create_IndivCtstmTrans</a></span>(<span class="no">wei_fits_cf</span>, <span class="no">transmod_data</span>,
                                      <span class="kw">trans_mat</span> <span class="kw">=</span> <span class="no">tmat</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="no">n_samples</span>,
                                      <span class="kw">clock</span> <span class="kw">=</span> <span class="st">"forward"</span>,
                                      <span class="kw">start_age</span> <span class="kw">=</span> <span class="no">patients</span>$<span class="no">age</span>)</pre></body></html></div>
<p>It is a good idea to evaluate the assumptions underlying multi-state models. <code>hesim</code> can help facilitate these analyses since hazards (<code>$hazard()</code>), cumulative hazards (<code>$cumhazard()</code>), and state probabilities (<code>$stateprobs()</code>) can be easily computed. As an illustration, we will predict hazards using the maximum likelihood estimates of the Weibull model for a single patient (<code>patient_id = 1</code>). To do so, we create new transition models based on a subset of the dataset <code>transmod_data</code> used above.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="co"># Predict hazard</span>
<span class="no">transmod_data_pat1</span> <span class="kw">&lt;-</span> <span class="no">transmod_data</span>[<span class="no">patient_id</span> <span class="kw">==</span> <span class="fl">1</span>]
<span class="no">predict_haz</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">fits</span>, <span class="no">clock</span>){
 <span class="no">transmod_cr_pat1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hesim/man/create_IndivCtstmTrans.html">create_IndivCtstmTrans</a></span>(<span class="no">fits</span>, <span class="no">transmod_data_pat1</span>,
                                            <span class="kw">trans_mat</span> <span class="kw">=</span> <span class="no">tmat</span>,
                                            <span class="kw">clock</span> <span class="kw">=</span> <span class="no">clock</span>,
                                            <span class="kw">point_estimate</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
  <span class="no">haz</span> <span class="kw">&lt;-</span> <span class="no">transmod_cr_pat1</span>$<span class="fu"><a href="https://rdrr.io/pkg/flexsurv/man/hazard.html">hazard</a></span>(<span class="kw">t</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">20</span>, <span class="fl">1</span>))
  <span class="no">title_clock</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/chartr.html">toupper</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">clock</span>, <span class="fl">1</span>, <span class="fl">1</span>)),
                       <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">clock</span>, <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nchar.html">nchar</a></span>(<span class="no">clock</span>)), <span class="kw">sep</span><span class="kw">=</span><span class="st">""</span>)
  <span class="no">haz</span>[, <span class="no">clock</span> <span class="kw">:=</span> <span class="no">title_clock</span>]
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">haz</span>[, ])
}</pre></body></html></div>
<p>We then plot the predicted hazard by treatment strategy and timescale.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="co"># Plot hazards</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"ggplot2"</span>)
<span class="no">haz</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbind</a></span>(<span class="fu">predict_haz</span>(<span class="no">wei_fits_cr</span>, <span class="st">"reset"</span>),
             <span class="fu">predict_haz</span>(<span class="no">wei_fits_cf</span>, <span class="st">"forward"</span>))
<span class="no">haz</span>[, <span class="no">trans_name</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">trans</span>,
                           <span class="kw">levels</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fl">4</span>,
                           <span class="kw">labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Healthy-&gt; Sick"</span>,
                                      <span class="st">"Healthy -&gt; Dead"</span>,
                                      <span class="st">"Sick -&gt; Healthy"</span>,
                                      <span class="st">"Sick -&gt; Dead"</span>))]
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">haz</span>[<span class="no">t</span> <span class="kw">&gt;</span> <span class="fl">0</span>],
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">t</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">hazard</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">clock</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">strategy_id</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~<span class="no">trans_name</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Years"</span>) + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Hazard"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_linetype.html">scale_linetype_discrete</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="st">"Strategy"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_color_discrete</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="st">"Clock"</span>) + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</pre></body></html></div>
<p><img src="individual-patient-simulation_files/figure-html/predicted_hazards_plot-1.png" width="672"></p>
<p>While the hazards from the healthy state are similar between the “clock forward” and “clock reset” approaches, they differ significantly in the sick state. Treatment effects (i.e., the hazard ratios between treatment strategies 1 and 2) are also largest in the sick state.</p>
<p>Additional analyses should be conducted as well. For instance, the hazards for treatment strategy 1 (the reference treatment strategy) could be assessed by comparing the Weibull model’s predictions with predictions from non-parametric (i.e., the Kaplan-Meier estimator) or semi-parametric (i.e., Cox) models. This can be performed using <code>mstate</code>, which can predict cumulative hazards and state probabilities in non-parametric and semi-parametric models. Furthermore, the Weibull model’s proportional hazards assumption should be tested using standard techniques such as plots of log time vs. the log cumulative hazard, inclusion of time-dependent covariates, and tests of the Schoenfeld residuals.</p>
</div>
<div id="utility-and-cost-models" class="section level3">
<h3 class="hasAnchor">
<a href="#utility-and-cost-models" class="anchor"></a><span class="header-section-number">4.1.2</span> Utility and cost models</h3>
<p>Models based on predicted means (see <code><a href="https://rdrr.io/pkg/hesim/man/tparams_mean.html">tparams_mean()</a></code>) can be created directly from the utility and cost tables using since they do not include covariates and therefore do not require input data.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="co"># Utility</span>
<span class="no">utilitymod</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hesim/man/create_StateVals.html">create_StateVals</a></span>(<span class="no">utility_tbl</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="no">n_samples</span>)

<span class="co"># Costs</span>
<span class="no">drugcostmod</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hesim/man/create_StateVals.html">create_StateVals</a></span>(<span class="no">drugcost_tbl</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="no">n_samples</span>)
<span class="no">medcostmod</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hesim/man/create_StateVals.html">create_StateVals</a></span>(<span class="no">medcost_tbl</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="no">n_samples</span>)
<span class="no">costmods</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">Drug</span> <span class="kw">=</span> <span class="no">drugcostmod</span>,
                 <span class="kw">Medical</span> <span class="kw">=</span> <span class="no">medcostmod</span>)</pre></body></html></div>
</div>
<div id="combining-the-disease-progression-cost-and-utility-models" class="section level3">
<h3 class="hasAnchor">
<a href="#combining-the-disease-progression-cost-and-utility-models" class="anchor"></a><span class="header-section-number">4.1.3</span> Combining the disease progression, cost, and utility models</h3>
<p>Now that the necessary transition, utility, and cost models have been created, we combine them to create separate economic models based on the “clock reset” and “clock forward” transition models, respectively.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">econmod_cr</span> <span class="kw">&lt;-</span> <span class="no">IndivCtstm</span>$<span class="fu">new</span>(<span class="kw">trans_model</span> <span class="kw">=</span> <span class="no">transmod_cr</span>,
                             <span class="kw">utility_model</span> <span class="kw">=</span> <span class="no">utilitymod</span>,
                             <span class="kw">cost_models</span> <span class="kw">=</span> <span class="no">costmods</span>)
<span class="no">econmod_cf</span> <span class="kw">&lt;-</span> <span class="no">IndivCtstm</span>$<span class="fu">new</span>(<span class="kw">trans_model</span> <span class="kw">=</span> <span class="no">transmod_cf</span>,
                             <span class="kw">utility_model</span> <span class="kw">=</span> <span class="no">utilitymod</span>,
                             <span class="kw">cost_models</span> <span class="kw">=</span> <span class="no">costmods</span>)</pre></body></html></div>
</div>
</div>
<div id="simulating-outcomes" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-outcomes" class="anchor"></a><span class="header-section-number">4.2</span> Simulating outcomes</h2>
<div id="disease-progression" class="section level3">
<h3 class="hasAnchor">
<a href="#disease-progression" class="anchor"></a><span class="header-section-number">4.2.1</span> Disease progression</h3>
<p>Disease progression can be simulated using the <code>$sim_disease()</code> method. In the individual-level simulation, unique trajectories through the multi-state model are simulated for each patient, treatment strategy, and PSA sample. Patients transition <code>from</code> an old health state that was entered at time <code>time_start</code> <code>to</code> a new health state at time <code>time_stop</code>.</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="co"># "Clock reset"</span>
<span class="no">econmod_cr</span>$<span class="fu">sim_disease</span>()
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">econmod_cr</span>$<span class="no">disprog_</span>)</pre></body></html></div>
<pre><code>##    sample strategy_id patient_id grp_id from to final time_start  time_stop
## 1:      1           1          1      1    1  2     0  0.0000000  0.1698811
## 2:      1           1          1      1    2  1     0  0.1698811  1.1913377
## 3:      1           1          1      1    1  2     0  1.1913377 10.8443971
## 4:      1           1          1      1    2  1     0 10.8443971 13.0849996
## 5:      1           1          1      1    1  2     0 13.0849996 15.0833682
## 6:      1           1          1      1    2  1     0 15.0833682 16.4043750</code></pre>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="co"># "Clock forward"</span>
<span class="no">econmod_cf</span>$<span class="fu">sim_disease</span>()</pre></body></html></div>
<p>State occupancy probabilities at different time points are computed using <code>$sim_stateprobs()</code>. First, we simulate state probabilities for the “clock reset” model.</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">econmod_cr</span>$<span class="fu">sim_stateprobs</span>(<span class="kw">t</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">20</span> , <span class="fl">1</span>/<span class="fl">12</span>))</pre></body></html></div>
<p>We can then compare state probabilities between the competing treatment strategies.</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="co"># Short funtion add create state name variable to data.tabale</span>
<span class="no">add_state_name</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>){
  <span class="no">x</span>[, <span class="no">state_name</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">state_id</span>,
                           <span class="kw">levels</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">tmat</span>),
                           <span class="kw">labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">tmat</span>))]
}

<span class="co"># Short function to create state probability "dataset" for plotting</span>
<span class="no">summarize_stprobs</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">stateprobs</span>){
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">stateprobs</span>[, <span class="fu">.</span>(<span class="kw">prob_mean</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">prob</span>)),
                  <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"strategy_id"</span>, <span class="st">"state_id"</span>, <span class="st">"t"</span>)]
  <span class="fu">add_state_name</span>(<span class="no">x</span>)
}

<span class="co"># Plot of state probabilities</span>
<span class="no">stprobs_cr</span> <span class="kw">&lt;-</span> <span class="fu">summarize_stprobs</span>(<span class="no">econmod_cr</span>$<span class="no">stateprobs_</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">stprobs_cr</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">t</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">prob_mean</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">strategy_id</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~<span class="no">state_name</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Years"</span>) + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Probability in health state"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_color_discrete</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="st">"Strategy"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</pre></body></html></div>
<p><img src="individual-patient-simulation_files/figure-html/stprobs_by_strategy_plot-1.png" width="672"></p>
<p>Next, we compare the state probabilities from the “clock reset” and “clock forward” models.</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">econmod_cf</span>$<span class="fu">sim_stateprobs</span>(<span class="kw">t</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">20</span> , <span class="fl">1</span>/<span class="fl">12</span>))
<span class="no">stprobs_cf</span> <span class="kw">&lt;-</span> <span class="fu">summarize_stprobs</span>(<span class="no">econmod_cf</span>$<span class="no">stateprobs_</span>)

<span class="co"># Compare "clock forward" and "clock reset" cases</span>
<span class="no">stprobs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbind</a></span>(<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(<span class="no">stprobs_cf</span>, <span class="kw">clock</span> <span class="kw">=</span> <span class="st">"Forward"</span>),
                 <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(<span class="no">stprobs_cr</span>, <span class="kw">clock</span> <span class="kw">=</span> <span class="st">"Reset"</span>))
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">stprobs</span>[<span class="no">strategy_id</span> <span class="kw">==</span> <span class="fl">1</span>],
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">t</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">prob_mean</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">clock</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~<span class="no">state_name</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Years"</span>) + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Probability in health state"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_color_discrete</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="st">"Clock"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</pre></body></html></div>
<p><img src="individual-patient-simulation_files/figure-html/stprobs_by_timescale_plot-1.png" width="672"></p>
<p>The probabilities are generally quite similar, implying that the choice of timescale has a small impact on the results. This is not unexpected given that patients spend considerably more time in the healthy state and the predicted hazard rates are very similar in the healthy state.</p>
</div>
<div id="qalys" class="section level3">
<h3 class="hasAnchor">
<a href="#qalys" class="anchor"></a><span class="header-section-number">4.2.2</span> QALYs</h3>
<p>QALYs (and life-years) are simulated using <code>$sim_qalys()</code>. By default, mean QALYs are computed by treatment strategy, health state, and PSA sample (the <code>by_patient</code> option can be used to compute aggregated QALYs at the patient level). Here, we used the “clock reset” model to compute both undiscounted QALYs (<code>dr = 0</code>) and QALYs discounted at 3%.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">econmod_cr</span>$<span class="fu"><a href="https://rdrr.io/pkg/hesim/man/sim_ev.html">sim_qalys</a></span>(<span class="kw">dr</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">.03</span>))
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">econmod_cr</span>$<span class="no">qalys_</span>)</pre></body></html></div>
<pre><code>##    sample strategy_id grp_id state_id dr    qalys      lys
## 1:      1           1      1        1  0 4.406736 7.264078
## 2:      1           1      1        2  0 1.432498 1.435944
## 3:      1           2      1        1  0 4.828593 7.959468
## 4:      1           2      1        2  0 1.401150 1.404520
## 5:      2           1      1        1  0 5.402086 6.275189
## 6:      2           1      1        2  0 1.723621 1.737719</code></pre>
<p>We summarize the simulated QALYs by computing means by treatment strategy and health state across the PSA samples.</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="no">qalys_summary</span> <span class="kw">&lt;-</span> <span class="no">econmod_cr</span>$<span class="no">qalys_</span>[, <span class="fu">.</span>(<span class="kw">mean</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">qalys</span>)),
                                    <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"strategy_id"</span>, <span class="st">"state_id"</span>, <span class="st">"dr"</span>)]
<span class="fu">add_state_name</span>(<span class="no">qalys_summary</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">qalys_summary</span>[<span class="no">dr</span> <span class="kw">==</span> <span class="fl">.03</span>],
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">strategy_id</span>), <span class="kw">y</span> <span class="kw">=</span> <span class="no">mean</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">state_name</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">stat</span> <span class="kw">=</span> <span class="st">"identity"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="st">""</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Strategy"</span>) + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Mean QALYs"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</pre></body></html></div>
<p><img src="individual-patient-simulation_files/figure-html/qalys_plot-1.png" width="672"></p>
</div>
<div id="costs" class="section level3">
<h3 class="hasAnchor">
<a href="#costs" class="anchor"></a><span class="header-section-number">4.2.3</span> Costs</h3>
<p>Costs are computed in the same way as QALYs, except that they are computed by category. We use the “clock reset” model and a 3% discount rate.</p>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="no">econmod_cr</span>$<span class="fu"><a href="https://rdrr.io/pkg/hesim/man/sim_ev.html">sim_costs</a></span>(<span class="kw">dr</span> <span class="kw">=</span> <span class="fl">0.03</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">econmod_cr</span>$<span class="no">costs_</span>)</pre></body></html></div>
<pre><code>##    sample strategy_id grp_id state_id   dr category     costs
## 1:      1           1      1        1 0.03     Drug 28337.831
## 2:      1           1      1        2 0.03     Drug  5688.312
## 3:      1           2      1        1 0.03     Drug 60406.594
## 4:      1           2      1        2 0.03     Drug 10780.498
## 5:      2           1      1        1 0.03     Drug 25205.487
## 6:      2           1      1        2 0.03     Drug  6851.297</code></pre>
<p>As with QALYs, we summarize costs by computing means (now by treatment strategy and category) across the PSA samples.</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"scales"</span>)
<span class="no">costs_summary</span> <span class="kw">&lt;-</span> <span class="no">econmod_cr</span>$<span class="no">costs_</span>[<span class="no">dr</span> <span class="kw">==</span> <span class="fl">.03</span> , <span class="fu">.</span>(<span class="kw">mean</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">costs</span>)),
                                   <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"strategy_id"</span>, <span class="st">"category"</span>)]
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">costs_summary</span>,
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">strategy_id</span>), <span class="kw">y</span> <span class="kw">=</span> <span class="no">mean</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">category</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">stat</span> <span class="kw">=</span> <span class="st">"identity"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="st">"Category"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="kw">label</span> <span class="kw">=</span> <span class="kw pkg">scales</span><span class="kw ns">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/label_dollar.html">dollar_format</a></span>()) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Strategy"</span>) + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Mean costs"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</pre></body></html></div>
<p><img src="individual-patient-simulation_files/figure-html/costs_plot-1.png" width="672"></p>
</div>
</div>
</div>
<div id="decision-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#decision-analysis" class="anchor"></a><span class="header-section-number">5</span> Decision analysis</h1>
<p>Once costs and QALYs are computed a cost-effectiveness analysis can be performed. The <code>$summarize()</code> method creates a <a href="https://hesim-dev.github.io/hesim/reference/ce.html">“cost-effectiveness”</a> object with mean costs and QALYs computed for each PSA sample. The <code><a href="https://rdrr.io/pkg/hesim/man/icea.html">icea()</a></code> and <code><a href="https://rdrr.io/pkg/hesim/man/icea.html">icea_pw()</a></code> can then be used for cost-effectiveness analysis as described <a href="icea.html">here</a>.</p>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="no">ce_sim</span> <span class="kw">&lt;-</span> <span class="no">econmod_cr</span>$<span class="fu">summarize</span>()
<span class="no">icea_out</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hesim/man/icea.html">icea</a></span>(<span class="no">ce_sim</span>, <span class="kw">dr_qalys</span> <span class="kw">=</span> <span class="fl">.03</span>, <span class="kw">dr_costs</span> <span class="kw">=</span> <span class="fl">.03</span>)
<span class="no">icea_pw_out</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hesim/man/icea.html">icea_pw</a></span>(<span class="no">ce_sim</span>, <span class="kw">comparator</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">dr_qalys</span> <span class="kw">=</span> <span class="fl">.03</span>, <span class="kw">dr_costs</span> <span class="kw">=</span> <span class="fl">.03</span>)</pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Devin Incerti, Jeroen P. Jansen.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
