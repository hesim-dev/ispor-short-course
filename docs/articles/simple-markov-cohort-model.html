<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple Markov Cohort Model • learnCEA</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Simple Markov Cohort Model">
<meta property="og:description" content="learnCEA">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">learnCEA</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/simple-markov-cohort-model.html">Simple Markov Cohort Model</a>
    </li>
    <li>
      <a href="../articles/probabilistic-sensitivity-analysis.html">Incorporating Probabilistic Sensitivity Analysis</a>
    </li>
    <li>
      <a href="../articles/simple-markov-cohort-model-hesim.html">Simple Markov Cohort Model (hesim)</a>
    </li>
    <li>
      <a href="../articles/partitioned-survival-model.html">Partitioned Survival Model</a>
    </li>
    <li>
      <a href="../articles/individual-patient-simulation.html">Individual Patient Simulation</a>
    </li>
    <li>
      <a href="../articles/decision-analysis.html">Decision Analysis</a>
    </li>
    <li class="divider">
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/hesim-dev/ispor-short-course/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="simple-markov-cohort-model_files/kePrint-0.0.1/kePrint.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Simple Markov Cohort Model</h1>
            
            <h4 class="date">2020-08-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/hesim-dev/ispor-short-course/blob/master/vignettes/simple-markov-cohort-model.Rmd"><code>vignettes/simple-markov-cohort-model.Rmd</code></a></small>
      <div class="hidden name"><code>simple-markov-cohort-model.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a><span class="header-section-number">1</span> Overview</h1>
<p>The most commonly used model for cost-effectiveness analysis (CEA) is the cohort discrete time state transition model (cDTSTM), commonly referred to as a Markov cohort model. In this tutorial we demonstrate implementation with <code>R</code> of the simplest of cDSTMs, a time-homogeneous model with transition probabilities that are constant over time. The entire analysis can be run using <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/00Index.html">Base R</a> (i.e., without installing any packages). However, we will use the following packages to create a nice looking cost-effectiveness table.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"knitr"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"kableExtra"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"magrittr"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"tibble"</span>)</pre></body></html></div>
<p>As an example, we will consider the 4-state sick-sicker model that has been described in more detail by <a href="https://arxiv.org/abs/2001.07824">Alarid-Escudero et al</a>. The model will be used to compare two treatment strategies, a “New” treatment and the existing “standard of care (SOC)”. The model consists 4 health states. Ordered from worst to best to worst, they are: Healthy (<em>H</em>), Sick (<em>S1</em>), Sicker (<em>S2</em>), and Death (<em>D</em>). Possible transitions from each state are displayed in the figure below.</p>
<p><img src="sick-sicker.png" width="700px"></p>
</div>
<div id="theory" class="section level1">
<h1 class="hasAnchor">
<a href="#theory" class="anchor"></a><span class="header-section-number">2</span> Theory</h1>
<div id="transition-probabilities" class="section level2">
<h2 class="hasAnchor">
<a href="#transition-probabilities" class="anchor"></a><span class="header-section-number">2.1</span> Transition probabilities</h2>
<p>Transition probabilities are the building blocks of Markov cohort models and used to simulate the probability that a cohort of patients is in each health state at each model cycle. To set notation, let <span class="math inline">\(p_t\)</span> be the transition probability matrix governing transitions from one time period (i.e., model cycle) to the next. <span class="math inline">\(x_t\)</span> is the state occupancy vector at time <span class="math inline">\(t\)</span>. In this example, <span class="math inline">\(p_t\)</span> is a <span class="math inline">\(4 \times 4\)</span> matrix and <span class="math inline">\(x_t\)</span> is a <span class="math inline">\(1 \times 4\)</span> vector containing the proportion of patients in each of the 4 health states.</p>
<p>At time <span class="math inline">\(0\)</span>, the state vector is <span class="math inline">\(x_0 = (1, 0, 0, 0)\)</span> since all patients are healthy. The state vector at time <span class="math inline">\(t+1\)</span> for each of <span class="math inline">\(T\)</span> model cycles can be computed using matrix multiplication,</p>
<p><span class="math display">\[
x_{t+1}= x_t p_t, \quad t = 0,\ldots,T
\]</span> The matrix containing state vectors across all model cycles is often referred to as the “Markov trace” in health economics. Note that since we are considering a time-homogeneous model in this example, we can remove the subscript from the transition matrix and set <span class="math inline">\(p_t = p\)</span>.</p>
</div>
<div id="costs-and-outcome" class="section level2">
<h2 class="hasAnchor">
<a href="#costs-and-outcome" class="anchor"></a><span class="header-section-number">2.2</span> Costs and outcome</h2>
<p>To perform a CEA, Markov models estimate expected (i.e., average) costs and outcomes for the cohort of interest. In our examples, quality-adjusted life-years (QALYs) will be used as the outcome.</p>
<p>Costs and QALYs are computed by assigning values to the health states (i.e., “state values”) and weighting the time spent in each state by these state values. For example, if utility in each of the four health states is given by the <span class="math inline">\(4 \times 1\)</span> vector <span class="math inline">\(u = (1, 0.75, 0.5, 0)^T\)</span> and say, <span class="math inline">\(x_1 = (.8, .1, 0.08, 0.02)\)</span>, then the weighted average utility would be given by <span class="math inline">\(x_{1}u = 0.915\)</span>. More generally, we can define a state vector at time <span class="math inline">\(t\)</span> as <span class="math inline">\(z_t\)</span> so that the expected value at time <span class="math inline">\(t\)</span> is given by</p>
<p><span class="math display">\[
EV_t = x_{t}z_{t}
\]</span></p>
<p>Future cost and outcomes are discounted using a discount rate. In discrete time, the “discount weight” at time <span class="math inline">\(t\)</span> is given by <span class="math inline">\(1/(1 + r)^t\)</span> where <span class="math inline">\(r\)</span> is the discount rate; in continuous time, it is given by <span class="math inline">\(e^{-rt}\)</span>. We will use discrete time here, meaning that the present value of expected values are given by,</p>
<p><span class="math display">\[
PV_t = \frac{EV_t}{(1+r)^t}
\]</span> The simplest way to aggregate discounted costs across model cycles is with the net present value,</p>
<p><span class="math display">\[
NPV = \sum_{t} PV_t
\]</span></p>
<p>It is important to note that in mathematical terms this a discrete approximation to a continuous integral, also known as a Riemann sum. That is, we only know that an expected value lies within a time interval (e.g., in model cycle 1, between year 0 and 1; in model cycle 2, between year 1 and 2; and so on). If we assume that events occur at the start of model cycles (i.e., a left Riemann sum), then expected values will be underestimated; conversely, if we assume that they occur at the end of model cycles (i.e., a right Riemann sum), then they will be overestimated. Another option is to use average of values at the left and right endpoints (i.e., the trapezoid rule). We will assume events occur at the start of model cycles.</p>
</div>
</div>
<div id="model-parameters" class="section level1">
<h1 class="hasAnchor">
<a href="#model-parameters" class="anchor"></a><span class="header-section-number">3</span> Model parameters</h1>
<div id="transition-probabilities-1" class="section level2">
<h2 class="hasAnchor">
<a href="#transition-probabilities-1" class="anchor"></a><span class="header-section-number">3.1</span> Transition probabilities</h2>
<div id="standard-of-care" class="section level3">
<h3 class="hasAnchor">
<a href="#standard-of-care" class="anchor"></a><span class="header-section-number">3.1.1</span> Standard of care</h3>
<p>The annual transition probabilities for SOC among our cohort of interest, say 25-year old patients, are defined as follows.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">p_hd</span> <span class="kw">&lt;-</span> <span class="fl">0.002</span> <span class="co"># constant probability of dying when Healthy (all-cause mortality)</span>
<span class="no">p_hs1</span> <span class="kw">&lt;-</span> <span class="fl">0.15</span> <span class="co"># probability of becoming Sick when Healthy</span>
<span class="no">p_s1h</span> <span class="kw">&lt;-</span> <span class="fl">0.5</span> <span class="co"># probability of becoming Healthy when Sick</span>
<span class="no">p_s1s2</span> <span class="kw">&lt;-</span> <span class="fl">0.105</span> <span class="co"># probability of becoming Sicker when Sick</span>
<span class="no">p_s1d</span> <span class="kw">&lt;-</span> <span class="fl">.006</span> <span class="co"># constant probability of dying when Sick</span>
<span class="no">p_s2d</span> <span class="kw">&lt;-</span> <span class="fl">.02</span> <span class="co"># constant probability of dying when Sicker</span></pre></body></html></div>
<p>These can be used to derive the probabilities of remaining in the same state during a model cycle.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">p_hh</span> <span class="kw">&lt;-</span> <span class="fl">1</span>  - <span class="no">p_hs1</span> - <span class="no">p_hd</span>
<span class="no">p_s1s1</span> <span class="kw">&lt;-</span> <span class="fl">1</span> - <span class="no">p_s1h</span> - <span class="no">p_s1s2</span>
<span class="no">p_s2s2</span> <span class="kw">&lt;-</span> <span class="fl">1</span> - <span class="no">p_s2d</span></pre></body></html></div>
<p>Using these probabilities, the transition probability matrix can then be defined.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">p_soc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">p_hh</span>,  <span class="no">p_hs1</span>,  <span class="fl">0</span>,      <span class="no">p_hd</span>,
    <span class="no">p_s1h</span>, <span class="no">p_s1s1</span>, <span class="no">p_s1s2</span>, <span class="no">p_s1d</span>,
    <span class="fl">0</span>,     <span class="fl">0</span>,      <span class="no">p_s2s2</span>, <span class="no">p_s2d</span>,
    <span class="fl">0</span>,     <span class="fl">0</span>,      <span class="fl">0</span>,      <span class="fl">1</span>),
  <span class="kw">byrow</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
  <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">4</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">4</span>
)
<span class="no">state_names</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"H"</span>, <span class="st">"S1"</span>, <span class="st">"S2"</span>, <span class="st">"D"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">p_soc</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">p_soc</span>) <span class="kw">&lt;-</span> <span class="no">state_names</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">p_soc</span>)</pre></body></html></div>
<pre><code>##        H    S1    S2     D
## H  0.848 0.150 0.000 0.002
## S1 0.500 0.395 0.105 0.006
## S2 0.000 0.000 0.980 0.020
## D  0.000 0.000 0.000 1.000</code></pre>
</div>
<div id="new-treatment" class="section level3">
<h3 class="hasAnchor">
<a href="#new-treatment" class="anchor"></a><span class="header-section-number">3.1.2</span> New treatment</h3>
<p>In evidence synthesis and cost-effectiveness modeling, treatment effects are typically estimated in relative terms; i.e., the effect of an intervention is assessed relative to a reference treatment. In this case, the SOC is the reference treatment and the effectiveness of the new treatment is assessed relative to the SOC. For simplicity, we will assume that treatment effects are defined in terms of the relative risk, which is assumed to reduce the probability of all transitions to a more severe health state by an equal amount. Note that this is somewhat unrealistic since relative risks are a function of baseline risk and would be unlikely to be equal for each transition. A more appropriate model would define treatment effects in terms of a measure that is invariant to baseline risk such as an odds ratio (which might still vary for each transition).</p>
<p>The relative risk can then be used to create the transition matrix for the new treatment. We will use assume the relative risk is <span class="math inline">\(0.8\)</span>.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">apply_rr</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">p</span>, <span class="no">rr</span> <span class="kw">=</span> <span class="fl">.8</span>){
  <span class="no">p</span>[<span class="st">"H"</span>, <span class="st">"S1"</span>] <span class="kw">&lt;-</span> <span class="no">p</span>[<span class="st">"H"</span>, <span class="st">"S1"</span>] * <span class="no">rr</span>
  <span class="no">p</span>[<span class="st">"H"</span>, <span class="st">"S2"</span>] <span class="kw">&lt;-</span> <span class="no">p</span>[<span class="st">"H"</span>, <span class="st">"S2"</span>] * <span class="no">rr</span>
  <span class="no">p</span>[<span class="st">"H"</span>, <span class="st">"D"</span>] <span class="kw">&lt;-</span> <span class="no">p</span>[<span class="st">"H"</span>, <span class="st">"S2"</span>] * <span class="no">rr</span>
  <span class="no">p</span>[<span class="st">"H"</span>, <span class="st">"H"</span>] <span class="kw">&lt;-</span> <span class="fl">1</span> - <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">p</span>[<span class="st">"H"</span>, -<span class="fl">1</span>])

  <span class="no">p</span>[<span class="st">"S1"</span>, <span class="st">"S2"</span>] <span class="kw">&lt;-</span> <span class="no">p</span>[<span class="st">"S1"</span>, <span class="st">"S2"</span>] * <span class="no">rr</span>
  <span class="no">p</span>[<span class="st">"S1"</span>, <span class="st">"D"</span>] <span class="kw">&lt;-</span> <span class="no">p</span>[<span class="st">"S1"</span>, <span class="st">"D"</span>] * <span class="no">rr</span>
  <span class="no">p</span>[<span class="st">"S1"</span>, <span class="st">"S1"</span>] <span class="kw">&lt;-</span> <span class="fl">1</span> - <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">p</span>[<span class="st">"S1"</span>, -<span class="fl">2</span>])

  <span class="no">p</span>[<span class="st">"S2"</span>, <span class="st">"D"</span>] <span class="kw">&lt;-</span> <span class="no">p</span>[<span class="st">"S2"</span>, <span class="st">"D"</span>] * <span class="no">rr</span>
  <span class="no">p</span>[<span class="st">"S2"</span>, <span class="st">"S2"</span>] <span class="kw">&lt;-</span> <span class="fl">1</span> - <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">p</span>[<span class="st">"S2"</span>, -<span class="fl">3</span>])

  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">p</span>)
}

<span class="no">p_new</span> <span class="kw">&lt;-</span> <span class="fu">apply_rr</span>(<span class="no">p_soc</span>, <span class="kw">rr</span> <span class="kw">=</span> <span class="fl">.8</span>)</pre></body></html></div>
</div>
</div>
<div id="utility-and-costs" class="section level2">
<h2 class="hasAnchor">
<a href="#utility-and-costs" class="anchor"></a><span class="header-section-number">3.2</span> Utility and costs</h2>
<p>Utility and (annualized) costs are defined below. We consider two types of costs: medical and treatment. Both utility and costs are 0 in the death state. Treatment costs are assumed equal in each health state.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">utility</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">.075</span>, <span class="fl">0.5</span>, <span class="fl">0</span>)
<span class="no">costs_medical</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2000</span>, <span class="fl">4000</span>, <span class="fl">15000</span>, <span class="fl">0</span>)
<span class="no">costs_treat_soc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">2000</span>, <span class="fl">3</span>), <span class="fl">0</span>)
<span class="no">costs_treat_new</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">12000</span>, <span class="fl">3</span>), <span class="fl">0</span>)</pre></body></html></div>
</div>
</div>
<div id="simulation" class="section level1">
<h1 class="hasAnchor">
<a href="#simulation" class="anchor"></a><span class="header-section-number">4</span> Simulation</h1>
<div id="health-state-probabilities" class="section level2">
<h2 class="hasAnchor">
<a href="#health-state-probabilities" class="anchor"></a><span class="header-section-number">4.1</span> Health state probabilities</h2>
<p>To simulate health state probabilities, we must specify a state vector at time 0. Each patient will start in the Healthy state.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">x_init</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>)</pre></body></html></div>
<p>The state vector during cycle <span class="math inline">\(1\)</span> for SOC is computed using simple matrix multiplication.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">x_init</span> <span class="kw">%*%</span> <span class="no">p_soc</span></pre></body></html></div>
<pre><code>##          H   S1 S2     D
## [1,] 0.848 0.15  0 0.002</code></pre>
<p>We can also easily compute the state vector at cycle 2 for SOC.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">x_init</span> <span class="kw">%*%</span>
  <span class="no">p_soc</span> <span class="kw">%*%</span>
  <span class="no">p_soc</span></pre></body></html></div>
<pre><code>##             H      S1      S2        D
## [1,] 0.794104 0.18645 0.01575 0.004596</code></pre>
<p>A for loop can be used to compute the state vector at each model cycle. Let’s create a function to do this. The model will be simulated until a maximum age of 110; that is, for 85 years for a cohort of 25-year olds.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">sim_markov_trace</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x0</span>, <span class="no">p</span>, <span class="no">n_cycles</span> <span class="kw">=</span> <span class="fl">85</span>){
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">NA</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">x0</span>), <span class="kw">nrow</span> <span class="kw">=</span> <span class="no">n_cycles</span>) <span class="co"># Initialize Markov trace</span>
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="no">x0</span>, <span class="no">x</span>) <span class="co"># Markov trace at cycle 0 is initial state vector</span>
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">p</span>) <span class="co"># Columns are the health states</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x</span>) <span class="kw">&lt;-</span> <span class="fl">0</span>:<span class="no">n_cycles</span> <span class="co"># Rows are the model cycles</span>
  <span class="kw">for</span> (<span class="no">t</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="no">n_cycles</span>){ <span class="co"># Simulating state vectors at each cycle with for loop</span>
    <span class="no">x</span>[<span class="no">t</span> + <span class="fl">1</span>, ] <span class="kw">&lt;-</span> <span class="no">x</span>[<span class="no">t</span>, ] <span class="kw">%*%</span> <span class="no">p</span>
  }
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">x</span>)
}</pre></body></html></div>
<p>We perform the computation for both the SOC and new treatment. As expected, patients remain in less severe health states longer when using the new treatment.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">x_soc</span> <span class="kw">&lt;-</span> <span class="fu">sim_markov_trace</span>(<span class="no">x_init</span>, <span class="no">p_soc</span>)
<span class="no">x_new</span> <span class="kw">&lt;-</span> <span class="fu">sim_markov_trace</span>(<span class="no">x_init</span>, <span class="no">p_new</span>)

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x_soc</span>)</pre></body></html></div>
<pre><code>##           H        S1         S2           D
## 0 1.0000000 0.0000000 0.00000000 0.000000000
## 1 0.8480000 0.1500000 0.00000000 0.002000000
## 2 0.7941040 0.1864500 0.01575000 0.004596000
## 3 0.7666252 0.1927633 0.03501225 0.007617908
## 4 0.7464798 0.1911353 0.05455216 0.011007983
## 5 0.7285826 0.1874704 0.07353032 0.014738798</code></pre>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x_new</span>)</pre></body></html></div>
<pre><code>##           H        S1         S2           D
## 0 1.0000000 0.0000000 0.00000000 0.000000000
## 1 0.8800000 0.1200000 0.00000000 0.000000000
## 2 0.8344000 0.1549440 0.01008000 0.000576000
## 3 0.8117440 0.1638410 0.02293402 0.001481011
## 4 0.7962552 0.1647807 0.03632971 0.002634392
## 5 0.7830949 0.1633084 0.04959002 0.004006615</code></pre>
</div>
<div id="expected-costs-and-quality-adjusted-life-years" class="section level2">
<h2 class="hasAnchor">
<a href="#expected-costs-and-quality-adjusted-life-years" class="anchor"></a><span class="header-section-number">4.2</span> Expected costs and quality-adjusted life-years</h2>
<p>To compute discounted costs and QALYS, it is helpful to write a general function for computing a present value.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">pv</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">z</span>, <span class="no">dr</span>, <span class="no">t</span>) {
  <span class="no">z</span>/(<span class="fl">1</span> + <span class="no">dr</span>)^<span class="no">t</span>
}</pre></body></html></div>
<div id="qalys" class="section level3">
<h3 class="hasAnchor">
<a href="#qalys" class="anchor"></a><span class="header-section-number">4.2.1</span> QALYs</h3>
<p>To illustrate a computation, lets start with discounted expected QALYs after the first model cycle.</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">x_soc</span>[<span class="fl">2</span>, ] <span class="co"># State occupancy probabilities after 1st cycle</span></pre></body></html></div>
<pre><code>##     H    S1    S2     D 
## 0.848 0.150 0.000 0.002</code></pre>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">x_soc</span>[<span class="fl">2</span>, <span class="fl">1</span>:<span class="fl">3</span>])) <span class="co"># Expected life-years after 1st cycle</span>
<span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">x_soc</span>[<span class="fl">2</span>, ] * <span class="no">utility</span>)) <span class="co"># Expected utility after 1st cycle</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="fu">pv</span>(<span class="no">x_soc</span>[<span class="fl">2</span>, ] * <span class="no">utility</span>, <span class="fl">.03</span>, <span class="fl">1</span>)) <span class="co"># Expected discounted utility after 1st cycle</span></pre></body></html></div>
<pre><code>## [1] 0.8342233</code></pre>
<p>Now let’s compute expected (discounted) QALYs for each cycle.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">compute_qalys</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">utility</span>, <span class="no">dr</span> <span class="kw">=</span> <span class="fl">.03</span>){
  <span class="no">n_cycles</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">x</span>) - <span class="fl">1</span>
  <span class="fu">pv</span>(<span class="no">x</span> <span class="kw">%*%</span> <span class="no">utility</span>, <span class="no">dr</span>, <span class="fl">0</span>:<span class="no">n_cycles</span>)
}

<span class="no">qalys_soc</span> <span class="kw">&lt;-</span> <span class="no">x_soc</span> <span class="kw">%*%</span> <span class="no">utility</span>
<span class="no">dqalys_soc</span> <span class="kw">&lt;-</span> <span class="fu">compute_qalys</span>(<span class="no">x_soc</span>, <span class="kw">utility</span> <span class="kw">=</span> <span class="no">utility</span>)
<span class="no">dqalys_new</span> <span class="kw">&lt;-</span> <span class="fu">compute_qalys</span>(<span class="no">x_new</span>, <span class="kw">utility</span> <span class="kw">=</span> <span class="no">utility</span>)

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">qalys_soc</span>)</pre></body></html></div>
<pre><code>##        [,1]
## 0 1.0000000
## 1 0.8592500
## 2 0.8159627
## 3 0.7985886
## 4 0.7880911
## 5 0.7794080</code></pre>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">dqalys_soc</span>)</pre></body></html></div>
<pre><code>##        [,1]
## 0 1.0000000
## 1 0.8342233
## 2 0.7691232
## 3 0.7308217
## 4 0.7002087
## 5 0.6723242</code></pre>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">dqalys_new</span>)</pre></body></html></div>
<pre><code>##        [,1]
## 0 1.0000000
## 1 0.8631068
## 2 0.8022064
## 3 0.7646000
## 4 0.7345821
## 5 0.7074583</code></pre>
</div>
<div id="costs" class="section level3">
<h3 class="hasAnchor">
<a href="#costs" class="anchor"></a><span class="header-section-number">4.2.2</span> Costs</h3>
<p>We can do the same for costs. The first column is medical costs and the second column is treatment costs.</p>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="no">compute_costs</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">costs_medical</span>, <span class="no">costs_treat</span>, <span class="no">dr</span> <span class="kw">=</span> <span class="fl">.03</span>){
  <span class="no">n_cycles</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">x</span>) - <span class="fl">1</span>
  <span class="no">costs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(
    <span class="fu">pv</span>(<span class="no">x</span> <span class="kw">%*%</span> <span class="no">costs_medical</span>, <span class="no">dr</span>, <span class="fl">0</span>:<span class="no">n_cycles</span>),
    <span class="fu">pv</span>(<span class="no">x</span> <span class="kw">%*%</span> <span class="no">costs_treat</span>, <span class="no">dr</span>, <span class="fl">0</span>:<span class="no">n_cycles</span>)
  )
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">costs</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"medical"</span>, <span class="st">"treatment"</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">costs</span>)
}

<span class="no">dcosts_soc</span> <span class="kw">&lt;-</span> <span class="fu">compute_costs</span>(<span class="no">x_soc</span>, <span class="no">costs_medical</span>, <span class="no">costs_treat_soc</span>)
<span class="no">dcosts_new</span> <span class="kw">&lt;-</span> <span class="fu">compute_costs</span>(<span class="no">x_new</span>, <span class="no">costs_medical</span>, <span class="no">costs_treat_new</span>)

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">dcosts_soc</span>)</pre></body></html></div>
<pre><code>##    medical treatment
## 0 2000.000  2000.000
## 1 2229.126  1937.864
## 2 2422.715  1878.224
## 3 2589.382  1820.035
## 4 2732.794  1763.056
## 5 2855.236  1707.246</code></pre>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">dcosts_new</span>)</pre></body></html></div>
<pre><code>##    medical treatment
## 0 2000.000  12000.00
## 1 2174.757  11650.49
## 2 2299.723  11304.64
## 3 2400.290  10965.44
## 4 2484.724  10633.76
## 5 2556.146  10309.83</code></pre>
</div>
</div>
</div>
<div id="cost-effectiveness-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#cost-effectiveness-analysis" class="anchor"></a><span class="header-section-number">5</span> Cost-effectiveness analysis</h1>
<p>We conclude by computing the incremental cost-effectiveness ratio (ICER) with the new treatment relative to SOC. It can be computed by summing the costs and QALYs we simulated in the previous section across all model cycles.</p>
<div class="sourceCode" id="cb33"><html><body><pre class="r">(<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">dcosts_new</span>) - <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">dcosts_soc</span>))/(<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">dqalys_new</span>) - <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">dqalys_soc</span>))</pre></body></html></div>
<pre><code>## [1] 115106.8</code></pre>
<p>For the sake of presentation, we might want to do a some extra work and create a nice looking table.</p>
<div class="sourceCode" id="cb35"><html><body><pre class="r"><span class="no">format_costs</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/formatc.html">formatC</a></span>(<span class="no">x</span>, <span class="kw">format</span> <span class="kw">=</span> <span class="st">"d"</span>, <span class="kw">big.mark</span> <span class="kw">=</span> <span class="st">","</span>)
<span class="no">format_qalys</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/formatc.html">formatC</a></span>(<span class="no">x</span>, <span class="kw">format</span> <span class="kw">=</span> <span class="st">"f"</span>, <span class="kw">digits</span> <span class="kw">=</span> <span class="fl">2</span>)
<span class="no">make_icer_tbl</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">costs0</span>, <span class="no">costs1</span>, <span class="no">qalys0</span>, <span class="no">qalys1</span>){
  <span class="co"># Computations</span>
  <span class="no">total_costs0</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">costs0</span>)
  <span class="no">total_costs1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">costs1</span>)
  <span class="no">total_qalys0</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">qalys0</span>)
  <span class="no">total_qalys1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">qalys1</span>)
  <span class="no">incr_total_costs</span> <span class="kw">&lt;-</span> <span class="no">total_costs1</span> - <span class="no">total_costs0</span>
  <span class="no">inc_total_qalys</span> <span class="kw">&lt;-</span> <span class="no">total_qalys1</span> - <span class="no">total_qalys0</span>
  <span class="no">icer</span> <span class="kw">&lt;-</span> <span class="no">incr_total_costs</span>/<span class="no">inc_total_qalys</span>

  <span class="co"># Make table</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(
    <span class="kw">`Costs`</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">total_costs0</span>, <span class="no">total_costs1</span>) <span class="kw">%&gt;%</span>
      <span class="fu">format_costs</span>(),
    <span class="kw">`QALYs`</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">total_qalys0</span>, <span class="no">total_qalys1</span>) <span class="kw">%&gt;%</span>
      <span class="fu">format_qalys</span>(),
    <span class="kw">`Inremental costs`</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"--"</span>, <span class="no">incr_total_costs</span> <span class="kw">%&gt;%</span>
                             <span class="fu">format_costs</span>()),
    <span class="kw">`Inremental QALYs`</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"--"</span>, <span class="no">inc_total_qalys</span> <span class="kw">%&gt;%</span>
                             <span class="fu">format_qalys</span>()),
    <span class="kw">`ICER`</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"--"</span>, <span class="no">icer</span> <span class="kw">%&gt;%</span> <span class="fu">format_costs</span>())
) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/footnote.html">footnote</a></span>(<span class="kw">general</span> <span class="kw">=</span> <span class="st">"Costs and QALYs are discounted at 3% per annum."</span>,
           <span class="kw">footnote_as_chunk</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
}
<span class="fu">make_icer_tbl</span>(<span class="kw">costs0</span> <span class="kw">=</span> <span class="no">dcosts_soc</span>, <span class="kw">costs1</span> <span class="kw">=</span> <span class="no">dcosts_new</span>,
              <span class="kw">qalys0</span> <span class="kw">=</span> <span class="no">dqalys_soc</span>, <span class="kw">qalys1</span> <span class="kw">=</span> <span class="no">dqalys_new</span>)</pre></body></html></div>
<table class="table table">
<thead><tr>
<th style="text-align:left;">
Costs
</th>
<th style="text-align:left;">
QALYs
</th>
<th style="text-align:left;">
Inremental costs
</th>
<th style="text-align:left;">
Inremental QALYs
</th>
<th style="text-align:left;">
ICER
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
212,706
</td>
<td style="text-align:left;">
19.95
</td>
<td style="text-align:left;">
–
</td>
<td style="text-align:left;">
–
</td>
<td style="text-align:left;">
–
</td>
</tr>
<tr>
<td style="text-align:left;">
491,167
</td>
<td style="text-align:left;">
22.37
</td>
<td style="text-align:left;">
278,460
</td>
<td style="text-align:left;">
2.42
</td>
<td style="text-align:left;">
115,106
</td>
</tr>
</tbody>
<tfoot><tr>
<td style="padding: 0; border: 0;" colspan="100%">
<span style="font-style: italic;">Note: </span> <sup></sup> Costs and QALYs are discounted at 3% per annum.
</td>
</tr></tfoot>
</table>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Devin Incerti, Jeroen P. Jansen.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
