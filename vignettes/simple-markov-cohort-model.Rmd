---
title: "Simple Markov Cohort Model"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_depth: 2
    number_sections: TRUE
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{Simple Markov Cohort Model}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---
# Overview
We illustrate the implementation of a simple Markov cohort model by replicating the HIV model developed by [Chancellor et al.](https://link.springer.com/article/10.2165/00019053-199712010-00006) and used for didactic purposes in the [*Decision Modeling for Health Economic Evaluation*](https://www.herc.ox.ac.uk/downloads/decision-modelling-for-health-economic-evaluation). The analysis compares two treatment strategies, zidovudine monotherapy and zidovudine + lamivudine combination therapy. The model is time-inhomogeneous because patients are assumed to only use lamivudine for 2 years before switching back to monotherapy.

The model consists 4 health states. Ordered from worst to best to worst, they are: State A (CD4 cells > 200 and < 500 cells/mm3), State B (CD4 < 200 cells/mm3), State C (AIDS), and State D (death). The model assumes that patients can transition to any state that is more severe (i.e., progress) but cannot transition back to a more severe state.

```{r, out.width = "700px", echo = FALSE}
knitr::include_graphics("simple-markov-cohort-model.png")
```

# Required R-package 
Install and load R Package â€˜expmâ€™ to compute the k-th power of a matrix
```{r, message = FALSE, warning=FALSE, results='hide'}
install.packages("expm",repos = "http://cran.us.r-project.org")
library(expm)
```

# Model settings
Define initial distribution over the 4 health stattes
```{r, message=FALSE}
initial<-matrix(c(1,0,0,0),nrow=1)
```
Show initial distribution
```{r, message=FALSE}
initial
```
set duration of follow-up
```{r, message=FALSE}
follow_up <- 20
```
Set discount rates for life years and costs
```{r, message=FALSE}
discount_LY <- 0.00
discount_cost <- 0.06
```

# Model parameters
## Transition matrix monotherapy
Define transition matrix with monotherapy
```{r, message=FALSE}
transitions_mono <- matrix(c(0.721, 0.202, 0.067, 0.010,
                        0, 0.581, 0.407, 0.012,
                        0, 0, 0.750, 0.250,
                        0, 0, 0, 1), 
                        ncol = 4, nrow = 4, byrow = TRUE)
```
Show transition matrix
```{r, message=FALSE}
transitions_mono
```

## Relative treatment effect with combination therapy
Define relative treatment effect with combination therapy relative to monotherapy
```{r, message=FALSE}
RR<-0.509
```

## Transition matrix combination therapy
Create transition matrix for combination therapy based on matrix for monotherapy and RR
```{r, message=FALSE}
transitions_combi <- matrix(c((1-0.202*RR-0.067*RR-0.010*RR), 0.202*RR, 0.067*RR, 0.010*RR,
                                      0, (1-0.407*RR-0.012*RR), 0.407*RR, 0.012*RR,
                                      0, 0, (1-0.250*RR), 0.250*RR,
                                      0, 0, 0, 1),
                                      ncol = 4, nrow = 4, byrow = TRUE)
```
Show transition matrix
```{r, message=FALSE}
transitions_combi
```

## Lifeyears and costs by health state
```{r, message=FALSE}
LY <- matrix(c(1, 1, 1, 0),nrow=1)

drug_cost_mono <- matrix(c(2278, 2278, 2278, 0),nrow=1)
drug_cost_combi <- matrix(c(2278+2087, 2278+2087, 2278+2087, 0),nrow=1)
other_cost <- matrix(c(2756, 3052, 9007, 0),nrow=1)
```
Show matrices
```{r, message=FALSE}
LY
drug_cost_mono
drug_cost_combi
other_cost
```

# Basic example calculations
## Health state occupancy with monotherapy
State occupancy at 1 year
```{r, message=FALSE}
initial %*% transitions_mono
```
State occupancy at 5 years
```{r, message=FALSE}
initial %*% transitions_mono %*% transitions_mono %*% transitions_mono %*% transitions_mono %*% transitions_mono
```
State occupancy at 5 years (efficient)
```{r, message=FALSE}
initial %*% (transitions_mono %^% 5)
```

## Expected life years and costs with monotherapy
The discounted expected life years after 5 years of follow-up can be calculated as follows:
```{r, message=FALSE}
expected_LY_mono <- sum(
            initial %*% (transitions_mono %^% 1) * LY * 1/(1+discount_LY)^1,
            initial %*% (transitions_mono %^% 2) * LY * 1/(1+discount_LY)^2,
            initial %*% (transitions_mono %^% 3) * LY * 1/(1+discount_LY)^3,
            initial %*% (transitions_mono %^% 4) * LY * 1/(1+discount_LY)^4,
            initial %*% (transitions_mono %^% 5) * LY * 1/(1+discount_LY)^5 
            )
expected_LY_mono
```

The discounted expected costs after 5 years of follow-up can be calculated as follows:
```{r, message=FALSE}
expected_total_cost_mono <- sum(
            initial %*% (transitions_mono %^% 1) * (drug_cost_mono + other_cost) * 1/(1+discount_cost)^1,
            initial %*% (transitions_mono %^% 2) * (drug_cost_mono + other_cost) * 1/(1+discount_cost)^2,
            initial %*% (transitions_mono %^% 3) * (drug_cost_mono + other_cost) * 1/(1+discount_cost)^3,
            initial %*% (transitions_mono %^% 4) * (drug_cost_mono + other_cost) * 1/(1+discount_cost)^4,
            initial %*% (transitions_mono %^% 5) * (drug_cost_mono + other_cost) * 1/(1+discount_cost)^5  
            ) 
expected_total_cost_mono
```

# Model output
## Monotherapy
Create an empty trace matrix for 6 variables and 20 cycles to record health occupancy and outcomes
```{r, message=FALSE}
trace_mono<-matrix(rep(NA, 6 * follow_up), nrow=follow_up)  
```
Create column headings
```{r, message=FALSE}
colnames(trace_mono) <- c("State A", "State B", "State C", "Death", "Disc LY", "Disc cost") 
```
Trace health state occupancy for a time-horizon of 20 years
```{r, message=FALSE}
for(t in 1:follow_up){
trace_mono[t,1:4] <- initial %*% (transitions_mono %^%t)
trace_mono[t,5] <- sum(  trace_mono[t,1:4] * LY * 1/(1+discount_LY)^t  )
trace_mono[t,6] <- sum(  trace_mono[t,1:4] * (drug_cost_mono + other_cost) * 1/(1+discount_cost)^t  )
}
trace_mono
```
Expected discounted life years with monotherapy for a 20-year time horizon
```{r, message=FALSE}
Expected_LY_mono <- sum(trace_mono[,5])
Expected_LY_mono
```
Expected discounted total costs with with monotherapy for a 20-year time horizon
```{r, message=FALSE}
Expected_total_cost_mono <- sum(trace_mono[,6])
Expected_total_cost_mono
```

## Combination therapy
Health state occupancy with combination therapy for a time-horizon of 20 years. Please note combination therapy is only provided for 2 years (2 cycles). 
```{r, message=FALSE}
trace_combi<-matrix(rep(NA, 6 * follow_up), nrow=follow_up)
colnames(trace_combi) <- c("State A", "State B", "State C", "Death", "Disc LY", "Disc cost")

for(t in 1:2){
  trace_combi[t,1:4] <- initial %*% (transitions_combi %^%t)
  trace_combi[t,5] <- sum(  trace_combi[t,1:4] * LY * 1/(1+discount_LY)^t  )
  trace_combi[t,6] <- sum(  trace_combi[t,1:4] * (drug_cost_combi + other_cost) * 1/(1+discount_cost)^t  )
}
for(t in 3:follow_up){
  trace_combi[t,1:4] <- trace_combi[2,1:4] %*% (transitions_mono %^% (t-2))
  trace_combi[t,5] <- sum(  trace_combi[t,1:4] * LY * 1/(1+discount_LY)^t  )
  trace_combi[t,6] <- sum(  trace_combi[t,1:4] * (drug_cost_mono + other_cost) * 1/(1+discount_cost)^t  )
}
trace_combi
```
Expected discounted life years with combination treatment for a 20-year time horizon
```{r, message=FALSE}
Expected_LY_combi <- sum(trace_combi[,5])
Expected_LY_combi
```
Expected discounted total costs with combination treatment for a 20-year time horizon
```{r, message=FALSE}
Expected_total_cost_combi <- sum(trace_combi[,6])
Expected_total_cost_combi
```

## Incremental Cost-Effectiveness Ratio
Incremental cost-effectiveness ratio in terms costs per life years with combination therapy relative to monotherapy
```{r, message=FALSE}
ICER  <- (Expected_total_cost_combi - Expected_total_cost_mono) / (Expected_LY_combi - Expected_LY_mono)
ICER
```


